name: Deploy to Cloudflare Workers

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-workers
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4
      - name: Preflight - whoami
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: whoami
      - name: Preflight - list KV namespaces
        continue-on-error: true
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: kv namespace list
      - name: Validate secrets presence
        env:
          CF_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          if [ -z "$CF_TOKEN" ]; then echo "Missing CLOUDFLARE_API_TOKEN secret"; exit 1; fi
          if [ -z "$CF_ACCOUNT" ]; then echo "Missing CLOUDFLARE_ACCOUNT_ID secret"; exit 1; fi
      - name: Optional inject KV ID from secret
        env:
          CF_KV_ID: ${{ secrets.CF_KV_ID }}
        run: |
          if [ -n "$CF_KV_ID" ]; then
            # Replace the ID for SUBSCRIPTIONS_KV regardless of where it is
            sed -i "s/id = \"[a-f0-9]\{32\}\"/id = \"$CF_KV_ID\"/g" wrangler.toml
            echo "Injected KV ID from secrets into wrangler.toml"
          fi
          echo "::group::wrangler.toml"
          cat wrangler.toml
          echo "::endgroup::"
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Install Wrangler CLI
        run: npm i -g wrangler@latest
      - name: Deploy to Cloudflare Workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: wrangler deploy
